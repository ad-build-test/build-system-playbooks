- name: Normal IOC Deployment
  hosts: all
  # All vars from ioc_deploy.yml are accessible
  gather_facts: no
  tasks:

  - name: Find siocRestart command
    ansible.builtin.shell: which siocRestart
    register: sioc_restart_path
    when: reboot_iocs == true

  - name: Reboot IOC using siocRestart
    ansible.builtin.shell: "{{ sioc_restart_path.stdout }} {{ item.name }}"
    loop: "{{ ioc_list }}"
    loop_control:
      label: 'siocRestart {{ item.name }}'
    when: reboot_iocs == true
    async: "{{ 0 if ansible_check_mode else 60 }}"  # disable async in check mode
    poll: 0
    register: restart_jobs

  - name: Wait for IOC reboots to complete
    async_status:
      jid: "{{ item.ansible_job_id }}"
    loop: "{{ restart_jobs.results }}"
    when: 
      - item.ansible_job_id is defined
      - not ansible_check_mode
    register: restart_status
    until: restart_status.finished
    retries: 20
    delay: 3
    no_log: true
    