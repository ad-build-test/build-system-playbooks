name: Request Deployment

on:
  workflow_call:
    inputs:
      deploy_to_dev:
        description: 'DEV'
        required: false
        type: boolean
        default: false
      deploy_to_lcls:
        description: 'LCLS'
        required: false
        type: boolean
        default: false
      deploy_to_facet:
        description: 'FACET'
        required: false
        type: boolean
        default: false
      deploy_to_testfac:
        description: 'TESTFAC'
        required: false
        type: boolean
        default: false
      deploy_to_sandbox:
        description: 'SANDBOX'
        required: false
        type: boolean
        default: false
      tag:
        description: 'Tag to deploy'
        required: true
        type: string
      deployment_type:
        description: 'Deployment type (e.g., pydm, epics-ioc)'
        required: false
        type: string
        default: 'pydm'

permissions:
  deployments: write
  contents: read
  actions: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Build Facility List
        id: facilities
        run: |
          FACILITIES=""
          [ "${{ inputs.deploy_to_dev }}" == "true" ] && FACILITIES="${FACILITIES}DEV,"
          [ "${{ inputs.deploy_to_lcls }}" == "true" ] && FACILITIES="${FACILITIES}LCLS,"
          [ "${{ inputs.deploy_to_facet }}" == "true" ] && FACILITIES="${FACILITIES}FACET,"
          [ "${{ inputs.deploy_to_testfac }}" == "true" ] && FACILITIES="${FACILITIES}TESTFAC,"
          [ "${{ inputs.deploy_to_sandbox }}" == "true" ] && FACILITIES="${FACILITIES}SANDBOX,"
          
          # Remove trailing comma
          FACILITIES=${FACILITIES%,}
          
          if [ -z "$FACILITIES" ]; then
            echo "Error: No facilities selected"
            exit 1
          fi
          
          echo "facilities=$FACILITIES" >> $GITHUB_OUTPUT
          echo "Selected facilities: $FACILITIES"
      
      - name: Create GitHub Deployment
        id: deployment
        uses: actions/github-script@v7
        with:
          script: |
            const deployment = await github.rest.repos.createDeployment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: '${{ inputs.tag }}',
              environment: 'deployment',
              required_contexts: [],
              auto_merge: false,
              payload: {
                facility: '${{ steps.facilities.outputs.facilities }}',
                tag: '${{ inputs.tag }}',
                user: '${{ github.actor }}',
                deploymentType: '${{ inputs.deployment_type }}'
              },
              description: 'Deploying ${{ inputs.tag }} to ${{ steps.facilities.outputs.facilities }}'
            });
            
            console.log('Deployment created with ID:', deployment.data.id);
            console.log('Payload:', JSON.stringify(deployment.data.payload));
            return deployment.data.id;
      
      - name: Log Deployment Details
        run: |
          echo "Deployment ID: ${{ steps.deployment.outputs.result }}"
          echo "Tag: ${{ inputs.tag }}"
          echo "Facility: ${{ steps.facilities.outputs.facilities }}"
